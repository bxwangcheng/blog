---
title: TCP/IP —— TCP协议
categories: 
- 技术
tags:
- 网络
- TCP/IP
---

再次理一理TCP协议

![30ffb10ad2efc91e4feb25f6ff0179dbe3a34126.jpg](https://i.loli.net/2020/03/02/VAgKew3HZE6UQFm.jpg)

<!-- more -->

------

TCP：Transmission Control Protocol

属于TCP/IP体系的**传输层**，传输的是**报文段**

【面向连接】【点对点】【可靠交付】【全双工通信】【面向字节流】



# 概述

可靠传输：确保数据按序送达

流量控制：终端之间的概念，确保接收方来得及接收数据

拥塞控制：链路上的概念，确保通信链路不过于拥挤



# 可靠传输

超时重传

滑动窗口



# 流量控制

发送窗口 & 接收窗口



# 拥塞控制

慢开始 & 拥塞避免

快重传 & 快恢复



# 连接管理

## 三次握手——建立连接

1. 客户端请求建立连接

   SYN = 1, ACK = 0, 序号x

2. 服务器响应

   SYN = 1, ACK =1, 确认号x+1, 序号y

3. 客户端确认服务器的响应，连接建立

   SYN = 1, ACK =1, 确认号y+1, 序号x+1

Q：为什么要三次握手，不能两次握手？

A：两次握手意味着服务器一旦收到客户端的连接请求就可以与之建立连接，那么若客户端没有收到服务器的确认报文段，再次向服务器发送请求建立连接的报文段，就会导致服务器建立多个连接，因此需要客户端对服务器的响应进行确认，确认服务器的响应，是响应来自自己最近一次的请求，若服务器响应的是超时重传前的请求，则不与它建立连接。

![三次握手.png](https://i.loli.net/2020/03/02/xroPZBgqHuevpEU.png)



## 四次挥手 —— 断开连接

1. 客户端请求断开

   发送请求释放连接报文段，FIN = 1， 序号x

2. 服务器确认断开，此时客户端到服务器断开

   发送响应释放连接报文段，ACK = 1，序号y，确认号x+1

   【此时，客户端作为主动请求断开的一方，已经单向断开对服务器的连接】
   【然而服务器作为被动断开的一方，也许还有未发送完成的数据，因此此时会等待一段时间】
   【现在这段时间为CLOSE_WAIT】

3. 服务器请求断开

   发送请求释放连接报文段，FIN = 1， 序号z
   【细节】序号是z而不是z+1是因为服务器有可能会发数据给客户端，因此需要可能不连续

4. 客户端确认断开，此时服务器到客户端断开

   发送响应释放连接报文段，ACK = 1，序号x+1，确认号z+1

   【细节】序号是x+1与请求断开的报文段是连续的是因为请求断开后不会再给服务器发送数据了，因此序号必定连续。

   【发出响应报文段后，进入TIME_WAIT = 2MSL 状态】
   【一是等待服务器收到客户端段释放请求，若未收到，服务器会再次发送释放请求报文段】
   【二是等待链路中与此次连接有关的报文段全部死亡，避免影响下一个连接】

   ![四次挥手.png](https://i.loli.net/2020/03/02/Pm2ItqlT1xbQviZ.png)



## 一些细节

`netstat`命令查看网路连接的状态

大量的TIME_WAIT状态：

1. TIME_WAIT是主动请求断开连接的一方在断开连接前需要保持的状态
2. 发送方持TIME_WAIT状态是为了确保：1. 接收方能收到确认关闭的报文；2. 等待本连接产生的报文段消失
3. 出现的原因：主动断开连接后没有结束TIME_WAIT状态；被动断开一方异常，反复发送FIN



大量的CLOSE_WAIT状态：

1. CLOSE_WAIT是被动关闭连接的一方在关闭连接前保持的状态
2. 保持这个状态是为了处理完未完成的发送任务
3. 出现的原因：被关闭方收到FIN请求后没有积极处理，没有向主动断开方发送FIN

------

# 参考资料

[1] 谢希仁, 计算机网络（第7版）